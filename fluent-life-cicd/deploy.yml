name: CD - Deploy to Server

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'

env:
  DOCKER_BUILDKIT: 1

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment directory on server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            mkdir -p /opt/fluent-life/fluent-life-api
            mkdir -p /opt/fluent-life/fluent-life-frontend
          EOF

      - name: Copy files to server
        run: |
          # ä½¿ç”¨ rsync åŒæ­¥æ–‡ä»¶ï¼ˆæŽ’é™¤ node_modules, .git ç­‰ï¼‰
          rsync -avz --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'dist' \
            --exclude '*.log' \
            --exclude '.env' \
            ./fluent-life-api/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/fluent-life/fluent-life-api/
          
          rsync -avz --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'dist' \
            --exclude '*.log' \
            ./fluent-life-frontend/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/fluent-life/fluent-life-frontend/

      - name: Deploy on server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'DEPLOY_SCRIPT'
            set -e
            cd /opt/fluent-life/fluent-life-api
            
            # æ£€æŸ¥ .env æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f .env ]; then
              echo "âš ï¸  .env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ‰‹åŠ¨åˆ›å»º"
              exit 1
            fi
            
            # ç¡®ä¿ä½¿ç”¨ docker compose v2
            if command -v docker &> /dev/null && docker compose version &> /dev/null; then
              COMPOSE_CMD="docker compose"
            elif command -v docker-compose &> /dev/null; then
              COMPOSE_CMD="docker-compose"
            else
              echo "âŒ Docker Compose æœªå®‰è£…"
              exit 1
            fi
            
            # æ‹‰å–æœ€æ–°ä»£ç ï¼ˆå¦‚æžœä½¿ç”¨ gitï¼‰
            # git pull origin main || true
            
            # åœæ­¢æ—§å®¹å™¨
            echo "ðŸ›‘ åœæ­¢æ—§å®¹å™¨..."
            $COMPOSE_CMD down || true
            
            # æž„å»ºæ–°é•œåƒ
            echo "ðŸ”¨ æž„å»º Docker é•œåƒ..."
            $COMPOSE_CMD build --no-cache
            
            # å¯åŠ¨æœåŠ¡
            echo "ðŸš€ å¯åŠ¨æœåŠ¡..."
            $COMPOSE_CMD up -d
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 15
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "ðŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            $COMPOSE_CMD ps
            
            # å¥åº·æ£€æŸ¥
            echo "ðŸ¥ å¥åº·æ£€æŸ¥..."
            sleep 5
            
            # æ£€æŸ¥åŽç«¯
            if curl -f http://localhost:8081/health > /dev/null 2>&1; then
              echo "âœ… åŽç«¯æœåŠ¡å¥åº·"
            else
              echo "âŒ åŽç«¯æœåŠ¡ä¸å¥åº·"
              $COMPOSE_CMD logs --tail 50 backend
              exit 1
            fi
            
            # æ£€æŸ¥å‰ç«¯
            if curl -f http://localhost > /dev/null 2>&1; then
              echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
            else
              echo "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
              $COMPOSE_CMD logs --tail 50 frontend
              exit 1
            fi
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          DEPLOY_SCRIPT

      - name: Deployment summary
        run: |
          echo "## ðŸš€ éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **åŽç«¯ API**: http://${{ secrets.SERVER_HOST }}:8081" >> $GITHUB_STEP_SUMMARY
          echo "- **å‰ç«¯**: http://${{ secrets.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å¥åº·æ£€æŸ¥**: http://${{ secrets.SERVER_HOST }}:8081/health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "éƒ¨ç½²æ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY

