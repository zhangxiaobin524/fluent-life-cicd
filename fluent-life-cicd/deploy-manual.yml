name: CD - Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•'
        required: false
        default: false
        type: boolean

env:
  DOCKER_BUILDKIT: 1

jobs:
  deploy:
    name: Manual Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tests (if not skipped)
        if: ${{ !inputs.skip_tests }}
        run: |
          echo "è¿è¡Œæµ‹è¯•..."
          # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æµ‹è¯•æ­¥éª¤

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to ${{ inputs.environment }}
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'DEPLOY_SCRIPT'
            set -e
            cd /opt/fluent-life/fluent-life-api
            
            if [ ! -f .env ]; then
              echo "âš ï¸  .env æ–‡ä»¶ä¸å­˜åœ¨"
              exit 1
            fi
            
            if command -v docker &> /dev/null && docker compose version &> /dev/null; then
              COMPOSE_CMD="docker compose"
            elif command -v docker-compose &> /dev/null; then
              COMPOSE_CMD="docker-compose"
            else
              echo "âŒ Docker Compose æœªå®‰è£…"
              exit 1
            fi
            
            echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨..."
            $COMPOSE_CMD down || true
            
            echo "ğŸ”¨ æ„å»º Docker é•œåƒ..."
            $COMPOSE_CMD build --no-cache
            
            echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
            $COMPOSE_CMD up -d
            
            sleep 15
            
            echo "ğŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            $COMPOSE_CMD ps
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          DEPLOY_SCRIPT

